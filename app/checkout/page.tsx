import type { Metadata } from "next"
import { validLoginCheckoutToken } from "@/actions/server"
import StripeLoader from "@/components/checkout/StripeLoader"
import { validateRecaptcha } from "@/actions/user"
import { getProduct, getProductPrice } from "@/lib/stripe"

export const metadata: Metadata = {
  title: "Great Vibe Events - Checkout",
  description: "Generated by create next app",
}

export default async function Checkout({
  searchParams,
}: {
  searchParams: { event_id?: string; token?: string; price?: string }
}) {
  try {
    if (!searchParams.event_id || !searchParams.price) {
      return <span className="text-red-500">Invalid event data.</span>
    }

    const event = await getProduct(searchParams.event_id)

    if (!event) {
      return <span className="text-red-500">Event not found.</span>
    }

    const price = await getProductPrice(searchParams.price)

    if (!price.unit_amount) {
      return <span className="text-red-500">Event price not found.</span>
    }

    if (!price.nickname) {
      return <span className="text-red-500">Price name not found.</span>
    }

    const now = Date.now()
    const eventDate = Number(event.metadata.starts)
    const eventEnds = Number(event.metadata.ends)
    const eventAddress = event.metadata.address

    if (now > eventDate) {
      return (
        <span className="text-red-500">
          Event ticket is not available for purchase.
        </span>
      )
    }
    return (
      <StripeLoader
        name={event.name}
        starts={eventDate}
        ends={eventEnds}
        address={eventAddress}
        packageName={price.nickname}
        amount={price.unit_amount}
      />
    )
  } catch (error: any) {
    console.error(error)
    if (error.type === "StripeInvalidRequestError") {
      return <span className="text-red-500">{error.raw.message}</span>
    } else {
      return <span className="text-red-500">Internal server error</span>
    }
  }
}
